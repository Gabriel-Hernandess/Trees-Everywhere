{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{% static 'management/css/trees.css' %}">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Scripts -->
    <script src="{% static 'management/js/trees.js' %}" defer></script>

    <!-- Font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>Admin</h2>
            <a href="{% url 'admin-accounts' %}">Contas <i class="fa-solid fa-users"></i></a>
            <a href="{% url 'admin-users' %}">Usuários <i class="fa-solid fa-circle-user"></i></a>
            <a class="active-page" href="{% url 'admin-trees' %}">Plantas <i class="fa-solid fa-tree"></i></a>
            <button onclick="confirmLogout()">Logout <i class="fa-solid fa-right-to-bracket"></i></button>
        </aside>

        <main class="content">
            <section id="trees" class="section">
                <div class="trees-header">
                    <h1>Árvores</h1>
                    <button onClick="openForm()">Nova árvore</button>
                </div>
                
                <div id="trees-list">
                    {% for tree in trees %}
                        <div class="item">
                            <p>{{ tree.name }} ({{ tree.scientific_name }})</p>

                            {% if tree.planted_trees %}
                                <button onclick="openPlanted({{ tree.id }})">Ver plantios</button>

                                <div class="planted-tree-list" style="display: none;" id="planted-{{ tree.id }}">
                                    <div class="planted-tree-container">
                                        <div class="list">
                                            <h4 style="color: #000;">{{ tree.name }} ({{ tree.scientific_name }})</p>
                                                
                                            {% for planted_tree in tree.planted_trees %}
                                                <div class="planted-tree-item" onclick="showOnMap({{ planted_tree.location_lat }}, {{ planted_tree.location_long }}, 'map-{{ tree.id }}')">
                                                    <p>Usuário: {{ planted_tree.user.username }}</p>
                                                    <p>Data: {{ planted_tree.planted_at }}</p>
                                                    <p>Conta: {{ planted_tree.account.name|default:"Sem conta associada" }}</p>
                                                </div>
                                            {% endfor %}
                                        </div>
            
                                        <div id="map-{{ tree.id }}" class="map"></div>
                                        <i class="fa-solid fa-xmark" onclick="closePlanted('planted-{{ tree.id }}')" style="color: black; cursor: pointer;"></i>
                                    </div>
                                </div>
                            {% else %}
                                <p>Sem plantios</p>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p>Nenhuma árvore encontrada</p>
                    {% endfor %}
                </div>


                <div class="overlay">
                    <div class="new-tree-form">
                        <h3>Nova árvore</h3>
                        
                        <input id="new-name" placeholder="Nome" />
                        <input id="new-scientific-name" placeholder="Nome cientifíco" />

                        <button onCLick="submitNewTree()">Criar árvore</button>
                        <button onCLick="closeForm()">Cancelar</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        function openForm(){
            const form = document.querySelector('.overlay');
            form.style.display = 'flex';
        }

        function closeForm(){
            const form = document.querySelector('.overlay');
            form.style.display = 'none';
        }

        window.addEventListener('DOMContentLoaded', () => {
            initMap(-23.5505, -46.6333);
        });

        function confirmLogout() {
            if (confirm("Tem certeza que deseja sair?")) {
                window.location.href = "/logout/";
            }
        }
    </script>
</body>
</html>